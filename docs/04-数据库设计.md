# 草莓栽培智能灌溉系统 - 数据库设计

以下是根据系统需求设计的数据库表结构及其列名。设计遵循了之前制定的命名规范（蛇形命名法），并考虑了数据完整性、查询效率以及与应用程序的映射关系。

---

## 1. 业务数据表 (存储在 PostgreSQL 中)

### 表: users (用户表)

| 列名 | 数据类型 | 约束 | 说明 |
|------|----------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 用户唯一标识，自增主键 |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名，用于登录 |
| password_hash | VARCHAR(255) | NOT NULL | 加密后的密码 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | 用户邮箱 |
| role | VARCHAR(20) | NOT NULL DEFAULT 'USER' | 用户角色：USER（农户）, ADMIN（管理员） |
| full_name | VARCHAR(100) | | 用户全名 |
| phone_number | VARCHAR(20) | | 手机号码 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | 账户创建时间 |
| updated_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | 最后更新时间 |

### 表: devices (设备表)

| 列名 | 数据类型 | 约束 | 说明 |
|------|----------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 设备唯一标识，自增主键 |
| name | VARCHAR(100) | NOT NULL | 设备名称（如"1号大棚湿度传感器"） |
| device_id | VARCHAR(100) | UNIQUE, NOT NULL | 设备物理ID（MQTT Client ID），用于MQTT通信 |
| type | VARCHAR(20) | NOT NULL | 设备类型：SENSOR（传感器）, ACTUATOR（执行器-水泵） |
| location | VARCHAR(255) | | 设备安装位置描述 |
| is_online | BOOLEAN | DEFAULT FALSE | 设备在线状态（通过心跳包维护） |
| last_active_at | TIMESTAMPTZ | | 最后活动时间 |
| created_by | BIGINT | FOREIGN KEY (users.id) | 设备创建者/所有者 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | 设备注册时间 |

### 表: irrigation_rules (灌溉规则表)

| 列名 | 数据类型 | 约束 | 说明 |
|------|----------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 规则唯一标识 |
| name | VARCHAR(100) | NOT NULL | 规则名称（如"土壤干旱自动灌溉"） |
| sensor_device_id | BIGINT | FOREIGN KEY (devices.id) | 关联的传感器设备ID |
| actuator_device_id | BIGINT | FOREIGN KEY (devices.id) | 关联的执行器（水泵）设备ID |
| threshold_operator | VARCHAR(5) | NOT NULL | 阈值比较运算符：<, <=, >, >= |
| threshold_value | DOUBLE PRECISION | NOT NULL | 触发规则的阈值（如 40.0 表示40%） |
| measured_parameter | VARCHAR(20) | NOT NULL | 监测的参数：SOIL_HUMIDITY（土壤湿度）, TEMPERATURE（温度）等 |
| action | VARCHAR(20) | NOT NULL | 触发后执行的动作：START_PUMP（开水泵） |
| duration_seconds | INT | | 动作持续秒数（如开水泵60秒） |
| is_enabled | BOOLEAN | DEFAULT TRUE | 规则是否启用 |
| created_by | BIGINT | FOREIGN KEY (users.id) | 规则创建者 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | 规则创建时间 |

### 表: irrigation_logs (灌溉日志表)

| 列名 | 数据类型 | 约束 | 说明 |
|------|----------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 日志唯一标识 |
| actuator_device_id | BIGINT | FOREIGN KEY (devices.id) | 被执行操作的设备ID |
| trigger_type | VARCHAR(20) | NOT NULL | 触发类型：MANUAL（手动）, AUTO（自动规则） |
| trigger_source | VARCHAR(100) | | 触发源。手动时为用户ID，自动时为规则ID |
| action | VARCHAR(20) | NOT NULL | 执行的动作：PUMP_ON, PUMP_OFF |
| status | VARCHAR(20) | NOT NULL | 执行状态：SUCCESS, FAILED（如网络超时） |
| message | TEXT | | 详细的日志信息或错误原因 |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | 日志创建时间 |

### 表: system_logs (系统日志表)

| 列名 | 数据类型 | 约束 | 说明 |
|------|----------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 日志唯一标识 |
| level | VARCHAR(10) | NOT NULL | 日志级别：INFO, WARN, ERROR |
| message | TEXT | NOT NULL | 日志内容 |
| module | VARCHAR(50) | | 产生日志的模块名 |
| user_id | BIGINT | FOREIGN KEY (users.id) | 关联的用户（如果适用） |
| created_at | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | 日志时间戳 |

---

## 2. 时序数据表 (存储在 TimescaleDB 超表中)

### 表: sensor_data (传感器数据表)

这是一个 TimescaleDB 超表 (Hypertable)，专门为高效存储和查询时间序列数据而优化。

| 列名 | 数据类型 | 约束 | 说明 |
|------|----------|------|------|
| time | TIMESTAMPTZ | NOT NULL DEFAULT NOW() | 时间戳（主维度）。TimescaleDB据此进行分区和压缩。 |
| device_id | BIGINT | FOREIGN KEY (devices.id), NOT NULL | 设备ID（第二维度）。用于区分不同设备的数据。 |
| soil_humidity | DOUBLE PRECISION | | 土壤湿度值（单位：%） |
| temperature | DOUBLE PRECISION | | 温度值（单位：摄氏度） |
| light_intensity | DOUBLE PRECISION | | 光照强度值 |
| battery_level | DOUBLE PRECISION | | 设备电池电量（可选） |

### 超表创建SQL示例：

```sql
-- 1. 创建普通表
CREATE TABLE sensor_data (
    time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    device_id BIGINT NOT NULL REFERENCES devices(id),
    soil_humidity DOUBLE PRECISION,
    temperature DOUBLE PRECISION,
    light_intensity DOUBLE PRECISION,
    battery_level DOUBLE PRECISION
);

-- 2. 将其转换为超表，按 'time' 列分区
SELECT create_hypertable('sensor_data', 'time');

-- 3. （可选但推荐）添加索引以提高按设备ID查询的性能
CREATE INDEX ON sensor_data (device_id, time DESC);

```

---

## 3. 关系与索引建议

### 外键关系 (Foreign Keys)：
- `devices.created_by` -> `users.id`
- `irrigation_rules.sensor_device_id` -> `devices.id`
- `irrigation_rules.actuator_device_id` -> `devices.id`
- `irrigation_rules.created_by` -> `users.id`
- `irrigation_logs.actuator_device_id` -> `devices.id`
- `sensor_data.device_id` -> `devices.id`

### 索引 (Indexes)：
- `users(username)`, `users(email)`：用于快速登录和查找。
- `devices(device_id)`：用于通过物理设备ID快速查找设备记录。
- `irrigation_rules(is_enabled)`：用于快速查询所有启用的自动规则。
- `irrigation_logs(created_at)`：用于按时间快速筛选日志。
- `system_logs(created_at)`：用于按时间筛选系统日志。
- `sensor_data(device_id, time DESC)`：最重要的索引之一，用于高效查询特定设备的历史数据。
```

- **时序数据优化** - 使用TimescaleDB超表处理传感器数据

现在你可以将这个Markdown文档保存并上传到GitHub仓库中。建议文件名为 `草莓栽培数据库设计.md` 或 `strawberry-irrigation-database-design.md`。
